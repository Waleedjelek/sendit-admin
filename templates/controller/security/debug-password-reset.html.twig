{% extends 'empty-base.html.twig' %}
{% block title %}Password Reset Debug - All Details{% endblock %}
{% block bodyClass %}debug-page{% endblock %}
{% block body %}
<div class="container-fluid" style="padding: 20px; max-width: 1400px; margin: 0 auto;">
    <div class="card">
        <div class="card-header">
            <h1 style="margin: 0;">Password Reset Debug - All Details (A-Z)</h1>
            <p style="margin: 5px 0 0 0; color: #666;">Comprehensive debugging information for password reset functionality</p>
        </div>
        <div class="card-body">
            <!-- Email Search Form -->
            <div class="card mb-4" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <h3>Search by Email</h3>
                    <form method="get" action="{{ path('app_debug_password_reset') }}">
                        <div class="form-group">
                            <label for="email">Email Address:</label>
                            <input type="email" id="email" name="email" class="form-control" value="{{ email }}" placeholder="Enter email address (A-Z)" style="text-transform: lowercase;">
                        </div>
                        <button type="submit" class="btn btn-primary">Load Debug Information</button>
                    </form>
                </div>
            </div>

            {% if email %}
                <div class="alert alert-info">
                    <strong>Debugging for email:</strong> {{ email }}
                </div>
            {% endif %}

            <!-- A. Email Configuration -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 style="margin: 0;">A. Email Configuration Details</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Setting</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Email Enabled</strong></td>
                            <td>
                                {% if debugData.email_config.enabled %}
                                    <span class="badge badge-success">Enabled</span>
                                {% else %}
                                    <span class="badge badge-danger">Disabled</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Sender Name</strong></td>
                            <td>{{ debugData.email_config.sender_name }}</td>
                        </tr>
                        <tr>
                            <td><strong>Sender Email</strong></td>
                            <td>{{ debugData.email_config.sender_email }}</td>
                        </tr>
                        <tr>
                            <td><strong>Return Email</strong></td>
                            <td>{{ debugData.email_config.return_email }}</td>
                        </tr>
                        <tr>
                            <td><strong>Mailer DSN</strong></td>
                            <td><code>{{ debugData.email_config.mailer_dsn }}</code></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- B. User Details -->
            {% if debugData.user_details is defined %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h2 style="margin: 0;">B. User Details</h2>
                </div>
                <div class="card-body">
                    {% if debugData.user_details.error is defined %}
                        <div class="alert alert-warning">{{ debugData.user_details.error }}</div>
                    {% else %}
                        <table class="table table-bordered table-striped">
                            <tr>
                                <th style="width: 30%;">Field</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td><strong>User ID</strong></td>
                                <td>{{ debugData.user_details.id }}</td>
                            </tr>
                            <tr>
                                <td><strong>Email</strong></td>
                                <td>{{ debugData.user_details.email }}</td>
                            </tr>
                            <tr>
                                <td><strong>First Name</strong></td>
                                <td>{{ debugData.user_details.first_name ?? 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Last Name</strong></td>
                                <td>{{ debugData.user_details.last_name ?? 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Role</strong></td>
                                <td>{{ debugData.user_details.role }}</td>
                            </tr>
                            <tr>
                                <td><strong>Active</strong></td>
                                <td>
                                    {% if debugData.user_details.active %}
                                        <span class="badge badge-success">Yes</span>
                                    {% else %}
                                        <span class="badge badge-danger">No</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Email Verified</strong></td>
                                <td>
                                    {% if debugData.user_details.email_verified %}
                                        <span class="badge badge-success">Yes</span>
                                    {% else %}
                                        <span class="badge badge-warning">No</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Created Date</strong></td>
                                <td>{{ debugData.user_details.created_date }}</td>
                            </tr>
                            <tr>
                                <td><strong>Last Login Date</strong></td>
                                <td>{{ debugData.user_details.last_login_date ?? 'Never' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Modified Date</strong></td>
                                <td>{{ debugData.user_details.modified_date ?? 'Never' }}</td>
                            </tr>
                        </table>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- C. Password Reset Token Details -->
            {% if debugData.password_reset_token is defined %}
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h2 style="margin: 0;">C. Password Reset Token Details</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Reset Token</strong></td>
                            <td><code style="word-break: break-all;">{{ debugData.password_reset_token.token ?? 'No token set' }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Token Date</strong></td>
                            <td>{{ debugData.password_reset_token.token_date ?? 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Token Age (Seconds)</strong></td>
                            <td>{{ debugData.password_reset_token.token_age_seconds ?? 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Token Age (Hours)</strong></td>
                            <td>{{ debugData.password_reset_token.token_age_hours ?? 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Is Expired</strong></td>
                            <td>
                                {% if debugData.password_reset_token.is_expired is null %}
                                    N/A
                                {% elseif debugData.password_reset_token.is_expired %}
                                    <span class="badge badge-danger">Yes (Expired)</span>
                                {% else %}
                                    <span class="badge badge-success">No (Valid)</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Expires In (Seconds)</strong></td>
                            <td>
                                {% if debugData.password_reset_token.expires_in_seconds is not null %}
                                    {{ debugData.password_reset_token.expires_in_seconds }} seconds
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- D. Email Template Details -->
            {% if debugData.email_template is defined %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h2 style="margin: 0;">D. Email Template Details</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Template Path</strong></td>
                            <td><code>{{ debugData.email_template.template_path }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Email Subject</strong></td>
                            <td>{{ debugData.email_template.subject }}</td>
                        </tr>
                        <tr>
                            <td><strong>Recipient Email</strong></td>
                            <td>{{ debugData.email_template.recipient }}</td>
                        </tr>
                        <tr>
                            <td><strong>Reset URL (Admin)</strong></td>
                            <td><a href="{{ debugData.email_template.reset_url_admin }}" target="_blank">{{ debugData.email_template.reset_url_admin }}</a></td>
                        </tr>
                        <tr>
                            <td><strong>Reset URL (API)</strong></td>
                            <td><a href="{{ debugData.email_template.reset_url_api }}" target="_blank">{{ debugData.email_template.reset_url_api }}</a></td>
                        </tr>
                        <tr>
                            <td><strong>Context Variables</strong></td>
                            <td>
                                <pre style="background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto;">{{ debugData.email_template.context_variables | json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- E. Email Message Details -->
            {% if debugData.email_message is defined %}
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h2 style="margin: 0;">E. Email Message Details</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>To (Recipients)</strong></td>
                            <td>{{ debugData.email_message.to | join(', ') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Subject</strong></td>
                            <td>{{ debugData.email_message.subject }}</td>
                        </tr>
                        <tr>
                            <td><strong>HTML Template</strong></td>
                            <td><code>{{ debugData.email_message.html_template }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Context</strong></td>
                            <td>
                                <pre style="background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto;">{{ debugData.email_message.context | json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- F. Password Reset Flow Details -->
            {% if debugData.password_reset_flow is defined %}
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h2 style="margin: 0;">F. Password Reset Flow Details</h2>
                </div>
                <div class="card-body">
                    <h4>Request Methods</h4>
                    <table class="table table-bordered table-striped mb-4">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Route</th>
                                <th>URL</th>
                                <th>Service Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Admin</strong></td>
                                <td><code>{{ debugData.password_reset_flow.request_methods.admin.route }}</code></td>
                                <td><a href="{{ debugData.password_reset_flow.request_methods.admin.url }}" target="_blank">{{ debugData.password_reset_flow.request_methods.admin.url }}</a></td>
                                <td><code>{{ debugData.password_reset_flow.request_methods.admin.service_method }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>API</strong></td>
                                <td><code>{{ debugData.password_reset_flow.request_methods.api.route }}</code></td>
                                <td><code>{{ debugData.password_reset_flow.request_methods.api.url }}</code></td>
                                <td><code>{{ debugData.password_reset_flow.request_methods.api.service_method }}</code></td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Validation Routes</h4>
                    <table class="table table-bordered table-striped mb-4">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Route</th>
                                <th>Pattern</th>
                                <th>Expiry (Seconds)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Admin</strong></td>
                                <td><code>{{ debugData.password_reset_flow.validation_routes.admin.route }}</code></td>
                                <td><code>{{ debugData.password_reset_flow.validation_routes.admin.pattern }}</code></td>
                                <td>{{ debugData.password_reset_flow.validation_routes.admin.expiry_seconds }}</td>
                            </tr>
                            <tr>
                                <td><strong>API</strong></td>
                                <td><code>{{ debugData.password_reset_flow.validation_routes.api.route }}</code></td>
                                <td><code>{{ debugData.password_reset_flow.validation_routes.api.pattern }}</code></td>
                                <td>{{ debugData.password_reset_flow.validation_routes.api.expiry_seconds }}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Rate Limiting</h4>
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Setting</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Enabled</strong></td>
                            <td>
                                {% if debugData.password_reset_flow.rate_limit.enabled %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge badge-danger">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Interval (Seconds)</strong></td>
                            <td>{{ debugData.password_reset_flow.rate_limit.interval_seconds }}</td>
                        </tr>
                        <tr>
                            <td><strong>Interval (Hours)</strong></td>
                            <td>{{ debugData.password_reset_flow.rate_limit.interval_hours }}</td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- G. Password Generation Details -->
            {% if debugData.password_generation is defined %}
            <div class="card mb-4">
                <div class="card-header" style="background-color: #6c757d; color: white;">
                    <h2 style="margin: 0;">G. Password Generation Details</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Field</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Generator Class</strong></td>
                            <td><code>{{ debugData.password_generation.generator_class }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Uppercase</strong></td>
                            <td>
                                {% if debugData.password_generation.settings.uppercase %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge badge-danger">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Lowercase</strong></td>
                            <td>
                                {% if debugData.password_generation.settings.lowercase %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge badge-danger">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Numbers</strong></td>
                            <td>
                                {% if debugData.password_generation.settings.numbers %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge badge-danger">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Symbols</strong></td>
                            <td>
                                {% if debugData.password_generation.settings.symbols %}
                                    <span class="badge badge-success">Yes</span>
                                {% else %}
                                    <span class="badge badge-danger">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Length</strong></td>
                            <td>{{ debugData.password_generation.settings.length }} characters</td>
                        </tr>
                        <tr>
                            <td><strong>Password Email Template</strong></td>
                            <td><code>{{ debugData.password_generation.password_email_template }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Password Email Subject</strong></td>
                            <td>{{ debugData.password_generation.password_email_subject }}</td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- H. Environment Variables -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #17a2b8; color: white;">
                    <h2 style="margin: 0;">H. Environment Variables</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Variable</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>APP_EMAIL_ENABLED</strong></td>
                            <td><code>{{ debugData.environment.APP_EMAIL_ENABLED }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>APP_EMAIL_SENDER_NAME</strong></td>
                            <td><code>{{ debugData.environment.APP_EMAIL_SENDER_NAME }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>APP_EMAIL_SENDER_EMAIL</strong></td>
                            <td><code>{{ debugData.environment.APP_EMAIL_SENDER_EMAIL }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>APP_EMAIL_RETURN_EMAIL</strong></td>
                            <td><code>{{ debugData.environment.APP_EMAIL_RETURN_EMAIL }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>MAILER_DSN</strong></td>
                            <td><code style="word-break: break-all;">{{ debugData.environment.MAILER_DSN }}</code></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- I. Messenger Configuration -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #ffc107; color: black;">
                    <h2 style="margin: 0;">I. Messenger Configuration</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">Setting</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Async Transport DSN</strong></td>
                            <td><code>{{ debugData.messenger_config.async_transport }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Email Async Disabled</strong></td>
                            <td>
                                {% if debugData.messenger_config.email_async_disabled %}
                                    <span class="badge badge-warning">Yes (Emails sent immediately)</span>
                                {% else %}
                                    <span class="badge badge-info">No (Emails queued)</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- J. Website URLs -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #28a745; color: white;">
                    <h2 style="margin: 0;">J. Website URLs</h2>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped">
                        <tr>
                            <th style="width: 30%;">URL Type</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td><strong>Admin Website URL</strong></td>
                            <td><a href="{{ debugData.website_urls.admin_website_url }}" target="_blank">{{ debugData.website_urls.admin_website_url }}</a></td>
                        </tr>
                        <tr>
                            <td><strong>User Website URL</strong></td>
                            <td><a href="{{ debugData.website_urls.user_website_url }}" target="_blank">{{ debugData.website_urls.user_website_url }}</a></td>
                        </tr>
                        <tr>
                            <td><strong>Marketing Website URL</strong></td>
                            <td><a href="{{ debugData.website_urls.marketing_website_url }}" target="_blank">{{ debugData.website_urls.marketing_website_url }}</a></td>
                        </tr>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .debug-page {
        background-color: #f4f6f9;
    }
    .card {
        box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
        margin-bottom: 1rem;
    }
    .card-header h2 {
        font-size: 1.25rem;
    }
    code {
        background-color: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    pre {
        max-height: 400px;
        overflow-y: auto;
    }
    .badge {
        padding: 0.25em 0.6em;
        font-weight: 700;
        font-size: 0.75em;
    }
    .badge-success {
        background-color: #28a745;
        color: white;
    }
    .badge-danger {
        background-color: #dc3545;
        color: white;
    }
    .badge-warning {
        background-color: #ffc107;
        color: black;
    }
    .badge-info {
        background-color: #17a2b8;
        color: white;
    }
</style>
{% endblock %}

